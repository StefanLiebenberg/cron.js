Date.prototype.addTime=function(c){this.setTime(this.getTime()+c)};Date.prototype.addMinutes=function(c){this.setMinutes(this.getMinutes()+c)};Date.prototype.addHours=function(c){this.setHours(this.getHours()+c)};Date.prototype.addDays=function(c){this.setDate(this.getDate()+c)};Date.prototype.addMonths=function(c){this.setMonth(this.getMonth()+c)};Date.prototype.addYears=function(c){this.setFullYear(this.getFullYear()+c)};
Array.prototype.uniq=function(){for(var c=0,g=this.length;c<g;c++)for(var j=this[c],d=c+1;(d=this.indexOf(j,d))!=-1;)this.splice(d,1),g--;return this};
window.CronSpec=new function(){function c(f,b){this.from=f;this.to=b;for(var a=f;a<=b;a++)this.push(a)}function g(f,b){this.matcher=f;this.block=b}function j(f,b){this.range=new c(f,b);this.parsers=[]}function d(f,b,a){this.allow=a;this.range=new c(f,b);this.parsers=[];this.aliases={};this.parsers.push(new g(/\,/,d.methods.comma));this.parsers.push(new g(/^\*$/,d.methods.all));this.parsers.push(new g(RegExp("^"+this.allow+"$"),d.methods.single));this.parsers.push(new g(RegExp("^"+this.allow+"-"+this.allow+
"$"),d.methods.range));this.parsers.push(new g(RegExp("^[^/]+/"+this.allow+"$"),d.methods.increment))}c.prototype=[];g.prototype={test:function(f){return this.matcher.test(f)},parse:function(f,b){return this.block.call(this,f,b)}};j.prototype.parse=function(f){for(var b=0,a=this.parsers.length;b<a;b++)if(this.parsers[b].test(f))return f=this.parsers[b].parse(f,this),f.uniq(),f.sort(function(a,b){return a-b}),f;return[]};d.prototype=new j(0,0);d.methods={all:function(f,b){return b.range.slice()},comma:function(f,
b){for(var a=f.split(","),c=[],d=0;d<a.length;d++)c.push.apply(c,b.parse(a[d]));return c},single:function(f,b){var a=parseInt(f)-b.range.from;return b.range.slice(a,a+1)},range:function(f,b){var a=f.split("-"),c=parseInt(a[0])-b.range.from,a=parseInt(a[1])-b.range.from;return b.range.slice(c,a+1)},increment:function(c,b){for(var a=c.split("/"),d=b.parse(a[0]),a=parseInt(a[1]),g=[],o=0,j=d.length;o<j;o+=a)g.push(d[o]);return g}};var p=new d(0,59,"[1-5]?[0-9]"),q=new d(0,59,"[1-5]?[0-9]"),v=new d(0,
23,"(([0-1]?[0-9])|([2][0-3]))"),w=new d(1,31,"(([0]?[1-9])|([1-2][0-9])|([3][0-1]))"),l=new d(1,12,"(([0]?[1-9])|([1][0-2]))"),k=new d(1,7,"([0]?[1-7])");l.aliases={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};k.aliases={sun:1,mon:2,tue:3,wed:4,thu:5,fri:6,sat:7};var m=new g(/([a-z][a-z][a-z])|([A-Z][A-Z][A-Z])/g,function(c,b){c=c.replace(this.matcher,function(a){a=a.toLowerCase();a in b.aliases&&(a=b.aliases[a]);return a});return b.parse(c)});l.parsers.push(m);k.parsers.push(m);
var n={"@second":"* * * * * *","@minute":"0 * * * * *","@halfminute":"0,30 * * * * *","@hour":"0 0 * * * *","@halfhour":"0 0,30 * * *","@daily":"0 0 0 * * *","@monthly":"0 0 0 1 * *","@yearly":"0 0 0 1 1 *","@weekly":"0 0 0 * * 1","@weekday":"0 0 0 * * 2-6"};this.parse=function(c){c=c.trim(" ");c in n&&(c=n[c]);var b=c.trim().split(" ");if(b.length!=6)throw Error("CronSpec only accepts cronstrings with 6 parts: "+c+" is invalid");return{spec:c,seconds:p.parse(b[0]),minutes:q.parse(b[1]),hours:v.parse(b[2]),
days:w.parse(b[3]),months:l.parse(b[4]),weekdays:k.parse(b[5])}};this.next=function(c,b){var a=new Date(c.getTime()+1E3);a.setMilliseconds(0);for(var d=b.seconds.length,g=d&&d!=60,j=b.minutes.length,l=j&&j!=60,k=b.hours.length,m=k&&k!=24,r=b.weekdays.length,n=r&&r!=7,s=b.days.length,p=s&&s.length!=31,t=b.months.length,q=t&&t!=12,u=!1;!u;){var h=a.getSeconds();if(g&&b.seconds.indexOf(h)==-1){for(var i=!0,e=0;e<d;e++)if(b.seconds[e]>=h){a.setSeconds(b.seconds[e]);i=!1;break}i&&(a.setSeconds(0),a.addMinutes(1))}else if(h=
a.getMinutes(),l&&b.minutes.indexOf(h)==-1){i=!0;for(e=0;e<j;e++)if(b.minutes[e]>=h){a.setMinutes(b.minutes[e]);i=!1;break}i&&(a.setMinutes(0),a.addHours(1))}else{h=a.getHours();if(m&&b.hours.indexOf(h)==-1){i=!0;for(e=0;e<k;e++)if(b.hours[e]>=h){a.setHours(b.hours[e]);i=!1;break}if(i){a.addDays(1);a.setSeconds(0);a.setMinutes(0);a.setHours(0);continue}}h=a.getDay()+1;if(n&&b.weekdays.indexOf(h)==-1){i=!0;for(e=0;e<r;e++)if(b.weekdays[e]>=h){a.addDays(b.weekdays[e]-h-1);i=!1;break}if(i){a.addDays(8-
h);a.setSeconds(0);a.setMinutes(0);a.setHours(0);continue}}h=a.getDate();if(p&&b.days.indexOf(h)==-1){i=!0;for(e=0;e<s;e++)if(b.days[e]>=h){for(;a.getDate()!=b.days[e];)a.setDate(b.days[e]);i=!1;break}a.setSeconds(0);a.setHours(0);a.setMinutes(0);i&&(a.setDate(1),a.addMonths(1))}else if(h=a.getMonth()+1,q&&b.months.indexOf(h)==-1){i=!0;for(e=0;e<t;e++)if(b.months[e]>=h){a.setMonth(b.months[e]-1);i=!1;break}a.setSeconds(0);a.setMinutes(0);a.setHours(0);a.setDate(1);i&&(a.setMonth(0),a.addYears(1))}else u=
!0}}return a}};function Cron(c,g){this.cronspec=CronSpec.parse(c);this.job=g;this.last_at=null;this.getNextAt()}Cron.prototype={getNextAt:function(){if(this.last_at){for(var c=CronSpec.next(this.last_at,this.cronspec),g=new Date;c<g;)c=CronSpec.next(c,this.cronspec);this.next_at=c}else this.next_at=CronSpec.next(new Date,this.cronspec)},getTimeout:function(){this.next_at||this.getNextAt();return Math.max(0,this.next_at-new Date)},run:function(){this.last_at=new Date;setTimeout(this.job,0);this.getNextAt()}};
var CronScheduler=function(){this.jobs=[];this.running=!1};
CronScheduler.prototype={add:function(c){this.jobs.push(c);this.running&&this.next()},remove:function(){for(var c;(c=this.jobs.indexOf(obj))!=-1;)this.jobs.splice(c)},start:function(){if(!this.running)this.running=!0,this.next()},stop:function(){if(this.running)this.running=!1,clearTimeout(this.storedTimeout),delete this.storedTimeout},next:function(){if(this.running&&!this.storedTimeout&&this.jobs.length){for(var c=this.jobs[0],g=1,j=this.jobs.length;g<j;g++)this.jobs[g].next_at<c.next_at&&(c=this.jobs[g]);
var d=this;this.storedTimeout=setTimeout(function(){c.run();delete d.storedTimeout;d.next()},c.getTimeout())}}};var Crontab=new CronScheduler;

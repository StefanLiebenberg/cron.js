Date.prototype.addTime=function(c){this.setTime(this.getTime()+c)};Date.prototype.addMinutes=function(c){this.setMinutes(this.getMinutes()+c)};Date.prototype.addHours=function(c){this.setHours(this.getHours()+c)};Date.prototype.addDays=function(c){this.setDate(this.getDate()+c)};Date.prototype.addMonths=function(c){this.setMonth(this.getMonth()+c)};Date.prototype.addYears=function(c){this.setFullYear(this.getFullYear()+c)};
Array.prototype.uniq=function(){for(var c=0,d=this.length;c<d;c++)for(var j=this[c],g=c+1;(g=this.indexOf(j,g))!=-1;)this.splice(g,1),d--;return this};
window.CronSpec=new function(){function c(f,b){this.from=f;this.to=b;for(var a=f;a<=b;a++)this.push(a)}function d(f,b){this.matcher=f;this.block=b}function j(f,b){this.range=new c(f,b);this.parsers=[]}function g(f,b,a){this.allow=a;this.range=new c(f,b);this.parsers=[];this.aliases={};this.parsers.push(new d(/\,/,g.methods.comma));this.parsers.push(new d(/^\*$/,g.methods.all));this.parsers.push(new d(RegExp("^"+this.allow+"$"),g.methods.single));this.parsers.push(new d(RegExp("^"+this.allow+"-"+this.allow+
"$"),g.methods.range));this.parsers.push(new d(RegExp("^[^/]+/"+this.allow+"$"),g.methods.increment))}c.prototype=[];d.prototype={test:function(f){return this.matcher.test(f)},parse:function(f,b){return this.block.call(this,f,b)}};j.prototype.parse=function(f){for(var b=0,a=this.parsers.length;b<a;b++)if(this.parsers[b].test(f))return f=this.parsers[b].parse(f,this),f.uniq(),f.sort(function(a,b){return a-b}),f;return[]};g.prototype=new j(0,0);g.methods={all:function(f,b){return b.range.slice()},comma:function(f,
b){for(var a=f.split(","),c=[],d=0;d<a.length;d++)c.push.apply(c,b.parse(a[d]));return c},single:function(f,b){var a=parseInt(f)-b.range.from;return b.range.slice(a,a+1)},range:function(f,b){var a=f.split("-"),c=parseInt(a[0])-b.range.from,a=parseInt(a[1])-b.range.from;return b.range.slice(c,a+1)},increment:function(f,b){for(var a=f.split("/"),c=b.parse(a[0]),a=parseInt(a[1]),d=[],g=0,j=c.length;g<j;g+=a)d.push(c[g]);return d}};var l=new g(0,59,"[1-5]?[0-9]"),p=new g(0,59,"[1-5]?[0-9]"),u=new g(0,
23,"(([0-1]?[0-9])|([2][0-3]))"),v=new g(1,31,"(([0]?[1-9])|([1-2][0-9])|([3][0-1]))"),k=new g(1,12,"(([0]?[1-9])|([1][0-2]))"),m=new g(1,7,"([0]?[1-7])");k.aliases={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};m.aliases={sun:1,mon:2,tue:3,wed:4,thu:5,fri:6,sat:7};var n=new d(/([a-z][a-z][a-z])|([A-Z][A-Z][A-Z])/g,function(c,b){c=c.replace(this.matcher,function(a){a=a.toLowerCase();a in b.aliases&&(a=b.aliases[a]);return a});return b.parse(c)});k.parsers.push(n);m.parsers.push(n);
var o={"@second":"* * * * * *","@minute":"0 * * * * *","@halfminute":"0,30 * * * * *","@hour":"0 0 * * * *","@halfhour":"0 0,30 * * *","@daily":"0 0 0 * * *","@monthly":"0 0 0 1 * *","@yearly":"0 0 0 1 1 *","@weekly":"0 0 0 * * 1","@weekday":"0 0 0 * * 2-6"};this.parse=function(c){c=c.trim(" ");c in o&&(c=o[c]);var b=c.trim().split(" ");if(b.length!=6)throw Error("CronSpec only accepts cronstrings with 6 parts: "+c+" is invalid");return{spec:c,seconds:l.parse(b[0]),minutes:p.parse(b[1]),hours:u.parse(b[2]),
days:v.parse(b[3]),months:k.parse(b[4]),weekdays:m.parse(b[5])}};this.next=function(c,b){var a=new Date(c.getTime()+1E3);a.setMilliseconds(0);for(var d=b.seconds.length,g=d&&d!=60,j=b.minutes.length,l=j&&j!=60,k=b.hours.length,m=k&&k!=24,q=b.weekdays.length,n=q&&q!=7,r=b.days.length,o=r&&r.length!=31,s=b.months.length,p=s&&s!=12,t=!1;!t;){var h=a.getSeconds();if(g&&b.seconds.indexOf(h)==-1){for(var i=!0,e=0;e<d;e++)if(b.seconds[e]>=h){a.setSeconds(b.seconds[e]);i=!1;break}i&&(a.setSeconds(0),a.addMinutes(1))}else if(h=
a.getMinutes(),l&&b.minutes.indexOf(h)==-1){i=!0;for(e=0;e<j;e++)if(b.minutes[e]>=h){a.setMinutes(b.minutes[e]);i=!1;break}i&&(a.setMinutes(0),a.addHours(1))}else{h=a.getHours();if(m&&b.hours.indexOf(h)==-1){i=!0;for(e=0;e<k;e++)if(b.hours[e]>=h){a.setHours(b.hours[e]);i=!1;break}if(i){a.addDays(1);a.setSeconds(0);a.setMinutes(0);a.setHours(0);continue}}h=a.getDay()+1;if(n&&b.weekdays.indexOf(h)==-1){i=!0;for(e=0;e<q;e++)if(b.weekdays[e]>=h){a.addDays(b.weekdays[e]-h-1);i=!1;break}if(i){a.addDays(8-
h);a.setSeconds(0);a.setMinutes(0);a.setHours(0);continue}}h=a.getDate();if(o&&b.days.indexOf(h)==-1){i=!0;for(e=0;e<r;e++)if(b.days[e]>=h){for(;a.getDate()!=b.days[e];)a.setDate(b.days[e]);i=!1;break}a.setSeconds(0);a.setHours(0);a.setMinutes(0);i&&(a.setDate(1),a.addMonths(1))}else if(h=a.getMonth()+1,p&&b.months.indexOf(h)==-1){i=!0;for(e=0;e<s;e++)if(b.months[e]>=h){a.setMonth(b.months[e]-1);i=!1;break}a.setSeconds(0);a.setMinutes(0);a.setHours(0);a.setDate(1);i&&(a.setMonth(0),a.addYears(1))}else t=
!0}}return a}};function Cron(c,d){this.cronspec=CronSpec.parse(c);this.job=d;this.last_at=null;this.getNextAt()}Cron.prototype={getNextAt:function(){if(this.last_at){for(var c=CronSpec.next(this.last_at,this.cronspec),d=new Date;c<d;)c=CronSpec.next(c,this.cronspec);this.next_at=c}else this.next_at=CronSpec.next(new Date,this.cronspec)},getTimeout:function(){this.next_at||this.getNextAt();return Math.max(0,this.next_at-new Date)},run:function(){this.last_at=new Date;this.job.apply(this);this.getNextAt()}};
var Crontab=new function(){if(this.constructor.instance)return this.constructor.instance;this.constructor.instance=this;var c=this.jobs=[];this.add=function(d){c.push(d);this.running&&this.next()};this.remove=function(){};this.next=function(){if(this.running&&!this.storedTimeout&&c.length){for(var d=c[0],j=1,g=c.length;j<g;j++)c[j].next_at<d.next_at&&(d=c[j]);var l=this;this.storedTimeout=setTimeout(function(){d.run();delete l.storedTimeout;l.next()},d.getTimeout())}};this.start=function(){if(!this.running)this.running=
!0,this.next()};this.stop=function(){if(this.running)this.running=!1,clearTimeout(this.storedTimeout),delete this.storedTimeout}};
